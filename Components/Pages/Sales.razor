@page "/sales"

@inherits NeocoreComponent

@inject SaleRepository SaleRepository
@inject EmployeeRepository EmployeeRepository
@inject NavigationManager Nav

<div class="row">
    <div class="col col-md-6">
        <FilterComponent 
            TEntity="Employee"
            SelectedId="EmployeeId"
            Entities="EmployeeList"
            EntityId="@(v => v.Id)"
            EntityName="@(v => v.FullName)"
            OnEntityFilter="UpdateQuery"
            Label="Sold by employee:" 
        />

        <label for="itemType">Includes items of type:</label>
        <input class="mt-2 form-control" id="itemType" type="text"
               @bind="ItemType"
               @bind:event="oninput"
               @onchange="() => UpdateQuery()" />
    </div>

    <div class="col col-md-6">
        <label for="dateFrom">Date from:</label>
        <input class="my-2 form-control" id="dateFrom" type="date"
               @bind="DateFrom"
               @bind:event="oninput"
               @onchange="() => UpdateQuery()" />

        <label for="dateTo">Date to:</label>
        <input class="mt-2 form-control" id="dateTo" type="date"
               @bind="DateTo"
               @bind:event="oninput"
               @onchange="() => UpdateQuery()" />
    </div>
</div>

<h3 class="mt-2">
    Sales
    <a href="/sale" class="btn btn-sm ms-2 py-1 btn-success">+ New</a>
</h3>

<QuickGrid class="nc-grid" Items="SaleList.AsQueryable()" Pagination="paginationState">
    <TemplateColumn class="nc-narrow"
                    Title="Id"
                    SortBy="GridSort<SaleExtended>.ByAscending(c => c.Sale == null ? null : c.Sale.Id)">
        <a href="sale/@context.Sale?.Id">@context.Sale?.Id</a>
    </TemplateColumn>
    <TemplateColumn Title="Date" SortBy="GridSort<SaleExtended>.ByDescending(c => c.Sale == null ? null : c.Sale.Date)">
        $@context.Sale?.Date
    </TemplateColumn>
    <TemplateColumn Title="Total" SortBy="GridSort<SaleExtended>.ByDescending(c => c.Sale == null ? null : c.Sale.Total)">
        $@context.Sale?.Total
    </TemplateColumn>
    <TemplateColumn Title="Items">
        @{
            var itemLinks = context.Items?
            .Select(i => $"<a href='/item/{i.Item?.Id}'>{i.Item?.Id}</a>")
            .ToList();
            @((MarkupString)(itemLinks == null ? "" : string.Join(", ", itemLinks)))
        }
    </TemplateColumn>
    <TemplateColumn Title="Sold by"
                    SortBy="GridSort<SaleExtended>.ByAscending(c => c.Employee == null ? null : c.Employee.FullName)">
        <a href="/employee/@context.Employee?.Id">@context.Employee?.FullName</a>
    </TemplateColumn>
    <TemplateColumn Title="Ordered by"
                    SortBy="GridSort<SaleExtended>.ByAscending(c => c.Customer == null ? null : c.Customer.FullName)">
        <a href="/customer/@context.Customer?.Id">@context.Customer?.FullName</a>
    </TemplateColumn>
    <Paginator State="paginationState" />
</QuickGrid>

@code {
    private PaginationState paginationState = new() { ItemsPerPage = 10 };

    private List<SaleExtended> SaleList { get; set; } = new();

    private List<Employee> EmployeeList { get; set; } = new();

    [Parameter]
    [SupplyParameterFromQuery(Name = "from")]
    public DateOnly DateFrom { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "to")]
    public DateOnly DateTo { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "itemType")]
    public string? ItemType { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "employee")]
    public int EmployeeId { get; set; }


    protected override async Task OnParametersSetAsync()
    {
        if (!IsPrerendering)
        {
            if (DateFrom == DateOnly.MinValue)
                DateFrom = new DateOnly(2024, 01, 01);

            if (DateTo == DateOnly.MinValue)
                DateTo = new DateOnly(2025, 01, 01);

            if (EmployeeList.Count <= 0)
                EmployeeList = [.. await EmployeeRepository.FindAll()];

            await UpdateSaleList();
        }

        await base.OnParametersSetAsync();
    }

    private async Task UpdateSaleList()
    {
        SaleList = [.. await SaleRepository.FindExtendedByFilter(new()
            {
                DateFrom = DateFrom,
                DateTo = DateTo,
                ItemType = !string.IsNullOrWhiteSpace(ItemType) ? ItemType : null,
                EmployeeId = EmployeeId > 0 ? EmployeeId : null
            }
        )];
    }

    public void UpdateQuery(int employeeId = -1)
    {
        employeeId = employeeId < 0 ? EmployeeId : employeeId;
        Nav.NavigateTo(
            Nav.GetUriWithQueryParameters(
                new Dictionary<string, object?>()
                    {
                        { "from", DateFrom != DateOnly.MinValue ? DateFrom : null },
                        { "to", DateTo != DateOnly.MinValue ? DateTo : null },
                        { "itemType", !string.IsNullOrWhiteSpace(ItemType) ? ItemType : null },
                        { "employee", employeeId > 0 ? employeeId : null },
                    }
            )
        );
    }
}
